name: Ecosystem PR Workflow

on:
  pull_request:
    branches:
      - ecosystem

jobs:
  check_PR: 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Check for details.json
        run: |
          if [ -f "details.json" ]; then
            echo "File 'details.json' found."
          else
            echo "Error: 'details.json' not found. Please include this file in your pull request."
            exit 1
          fi

  process_PR:  
    runs-on: ubuntu-latest
    needs: check_PR
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Extract project name from details.json
        run: |
          project_name=$(jq -r '.name' details.json)
          echo "::set-output name=project_name::$project_name"

      - name: Create new branch from master
        run: |
          git checkout -b submission/$project_name origin/master
        shell: bash

      - name: Create folder and move details.json
        run: |
          project_name=$(echo "${{ steps.extract_project_name.outputs.project_name }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
          mkdir -p static/ecosystem/$project_name
          git show ${{ github.event.pull_request.head.ref }}:details.json > static/ecosystem/$project_name/details.json

      - name: Commit and push changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add static/ecosystem/$project_name/details.json
          git commit -m "Ecosystem: add details.json for $project_name"
          git push

      - name: Create pull request
        uses: peter-evans/create-pull-request@v3
        with:
          title: "Add $project_name into ecosystem"
          commit-message: "Add details.json for $project_name into ecosystem"
          branch: ecosystem/$project_name
          base: master

      - name: Close initial PR
        run: gh pr close ${{ github.event.number }}

      - name: Delete inital branch
        run: git push origin --delete ${{ github.event.pull_request.head.ref }}
